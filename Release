node ('master') {
   def mvnHome
   stage('Preparation') {
      git 'https://github.com/andyneeb/ansible-demo-app.git'
      mvnHome = tool 'M3'
   }

   stage('Build') {
      withEnv(["MVN_HOME=$mvnHome"]) {
        sh '"$MVN_HOME/bin/mvn" -B release:prepare'
      }
   }

   stage('Package') {
      withEnv(["MVN_HOME=$mvnHome"]) {
        sh '"$MVN_HOME/bin/mvn" release:perform'
      }
   }

   stage('Release') {
      sh 'tower-cli config host tower.andyneeb.com'
      sh 'tower-cli config verify_ssl false'
      sh 'tower-cli config username jenkins'
      sh 'tower-cli config password jenkins'
      sh 'tower-cli job_template create --name "Release Demo App v$(lastversion andyneeb/ansible-demo-app)" --project "Demo App Repo" --playbook "plays/simple.yml" --inventory "OpenStack Prod" --extra-vars=app_release=$(lastversion andyneeb/ansible-demo-app) --extra-vars=app_stage=release --ask-limit-on-launch TRUE --credential "RHEL Cloud User Secure"'
      sh 'tower-cli role grant --type "execute" --user "release_manager" --job-template "Release Demo App v$(lastversion andyneeb/ansible-demo-app)"'
      sh 'tower-cli job_template delete --name "Release Demo App v$(bc <<< $(lastversion andyneeb/ansible-demo-app)-0.2)"'
     }
}
